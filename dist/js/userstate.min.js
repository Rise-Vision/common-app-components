!function(e){"use strict";try{e.module("risevision.common.config")}catch(n){e.module("risevision.common.config",[])}e.module("risevision.common.config").value("ENABLE_EXTERNAL_LOGGING",!0).value("CORE_URL","https://rvaserver2.appspot.com/_ah/api"),e.module("risevision.common.components.util",[]),e.module("risevision.common.components.logging",[]),e.module("risevision.common.components.rvtokenstore",["risevision.common.components.util","LocalStorageModule","ngBiscuit"]),e.module("risevision.common.components.userstate",["ui.router","risevision.common.components.util","risevision.common.components.rvtokenstore","risevision.common.components.logging","risevision.common.config","risevision.common.gapi","LocalStorageModule","risevision.core.cache","risevision.core.oauth2","risevision.core.company","risevision.core.util","risevision.core.userprofile","risevision.common.loading","risevision.ui-flow"]).value("CLIENT_ID","614513768474.apps.googleusercontent.com")}(angular),angular.module("risevision.common.components.logging").factory("bigQueryLogging",["externalLogging","userState",function(e,n){var t={};return t.logEvent=function(t,o,r){return e.logEvent(t,o,r,n.getUsername(),n.getSelectedCompanyId())},t}]),function(e){"use strict";e.module("risevision.common.components.userstate").factory("companyState",["$location","getCompany","objectHelper","$rootScope","$log","$q",function(n,t,o,r,i,a){var s,c={userCompany:{},selectedCompany:{}},u=function(){o.clearObj(c.selectedCompany),o.clearObj(c.userCompany),i.debug("Company state has been reset.")};n.search().cid&&(i.debug("cid",n.search().cid,"saved for later processing."),s=n.search().cid);var l=function(){var e=a.defer();return t().then(function(e){var n=p.getSelectedCompanyId()?p.getSelectedCompanyId():s;return o.clearAndCopy(e,c.userCompany),m(n)}).then(null,function(){p.resetCompany()}).finally(function(){s=null,e.resolve(null)}),e.promise},m=function(e){var n=a.defer();return e&&e!==c.userCompany.id?t(e).then(function(e){o.clearAndCopy(e,c.selectedCompany),n.resolve(),r.$broadcast("risevision.company.selectedCompanyChanged")}).then(null,function(e){i.error("Failed to load selected company.",e),n.reject(e)}):(p.resetCompany(),n.resolve()),n.promise},p={init:l,switchCompany:m,updateCompanySettings:function(e){e&&e.id===p.getSelectedCompanyId()&&o.clearAndCopy(e,c.selectedCompany),e&&e.id===p.getUserCompanyId()&&o.clearAndCopy(e,c.userCompany),r.$broadcast("risevision.company.updated",{companyId:e.id})},resetCompany:function(){o.clearAndCopy(c.userCompany,c.selectedCompany),r.$broadcast("risevision.company.selectedCompanyChanged")},resetCompanyState:u,getUserCompanyId:function(){return c.userCompany&&c.userCompany.id||null},getUserCompanyName:function(){return c.userCompany&&c.userCompany.name||null},getSelectedCompanyId:function(){return c.selectedCompany&&c.selectedCompany.id||null},getSelectedCompanyName:function(){return c.selectedCompany&&c.selectedCompany.name||null},getSelectedCompanyCountry:function(){return c.selectedCompany&&c.selectedCompany.country||null},getCopyOfUserCompany:function(n){return n?e.extend({},c.userCompany):o.follow(c.userCompany)},getCopyOfSelectedCompany:function(n){return n?e.extend({},c.selectedCompany):o.follow(c.selectedCompany)},isSubcompanySelected:function(){return c.selectedCompany&&c.selectedCompany.id!==(c.userCompany&&c.userCompany.id)},isTestCompanySelected:function(){return c.selectedCompany&&c.selectedCompany.isTest===!0},isSeller:function(){return c.selectedCompany&&c.selectedCompany.sellerId?!0:!1},isRootCompany:function(){return c.userCompany&&!c.userCompany.parentId}};return p}])}(angular),angular.module("risevision.common.components.logging").constant("EXTERNAL_LOGGER_SERVICE_URL","https://www.googleapis.com/bigquery/v2/projects/client-side-events/datasets/Apps_Events/tables/TABLE_ID/insertAll").constant("EXTERNAL_LOGGER_REFRESH_URL","https://www.googleapis.com/oauth2/v3/token?client_id=1088527147109-6q1o2vtihn34292pjt4ckhmhck0rk0o7.apps.googleusercontent.com&client_secret=nlZyrcPLg6oEwO9f9Wfn29Wh&refresh_token=1/xzt4kwzE1H7W9VnKB8cAaCx6zb4Es4nKEoqaYHdTD15IgOrJDtdun6zK6XiATCKT&grant_type=refresh_token").factory("externalLogging",["$http","$window","$q","$log","EXTERNAL_LOGGER_REFRESH_URL","EXTERNAL_LOGGER_SERVICE_URL","ENABLE_EXTERNAL_LOGGING",function(e,n,t,o,r,i,a){var s,c,u={},l=function(){var e=new Date,n=e.getUTCFullYear(),t=e.getUTCMonth()+1,o=e.getUTCDate();return 10>t&&(t="0"+t),10>o&&(o="0"+o),n.toString()+t.toString()+o.toString()},m={kind:"bigquery#tableDataInsertAllRequest",skipInvalidRows:!1,ignoreUnknownValues:!1,templateSuffix:l(),rows:[{insertId:"",json:{event:"",event_details:"",event_value:0,host:"",ts:0,user_id:"",company_id:""}}]};return u.logEvent=function(r,s,c,l,p){if(o.debug("BQ log",r,s,c,l,p),a===!1)return o.debug("External Logging DISABLED"),void 0;var d=t.defer();return u.getToken().then(function(t){var a=JSON.parse(JSON.stringify(m)),u=i.replace("TABLE_ID","apps_events");a.rows[0].insertId=Math.random().toString(36).substr(2).toUpperCase(),a.rows[0].json.event=r,s&&(a.rows[0].json.event_details=s),c&&(a.rows[0].json.event_value=c),a.rows[0].json.user_id=l||"",a.rows[0].json.company_id=p||"",a.rows[0].json.host=n.location.hostname,a.rows[0].json.ts=(new Date).toISOString(),e.post(u,a,{headers:{"Content-Type":"application/json",Authorization:"Bearer "+t}}).then(function(e){d.resolve(e)},function(e){o.debug("error posting to BQ",e),d.reject(e)})},function(e){o.debug("BQ token ERROR",e),d.reject(e)}),d.promise},u.getToken=function(){var n=t.defer();return s&&(new Date).getTime()-c<358e4?n.resolve(s):e.post(r).then(function(e){s=e.data.access_token,c=(new Date).getTime(),n.resolve(e.data.access_token)},function(){n.reject()}),n.promise},u}]),function(e){"use strict";e.module("risevision.common.components.rvtokenstore").service("rvTokenStore",["$log","$location","cookieStore","getBaseDomain",function(e,n,t,o){var r=function(){return t.get("rv-token")},i=function(e){var n=o();"localhost"===n?t.put("rv-token",e,{path:"/"}):t.put("rv-token",e,{domain:n,path:"/"})},a=function(){var e=o();"localhost"===e?t.remove("rv-token",{path:"/"}):t.remove("rv-token",{domain:e,path:"/"})},s={read:r,write:i,clear:a};return s}])}(angular),function(e){"use strict";e.module("risevision.common.components.userstate").run(["$rootScope","userState","selectedCompanyUrlHandler",function(e,n,t){e.$on("risevision.company.selectedCompanyChanged",function(e){e&&t.updateUrl()}),e.$on("$stateChangeSuccess",t.updateSelectedCompanyFromUrl),e.$on("$routeChangeSuccess",t.updateSelectedCompanyFromUrl),e.$on("$locationChangeSuccess",t.locationChangeSuccess)}]).service("selectedCompanyUrlHandler",["$state","$stateParams","$location","userState",function(e,n,t,o){this.updateUrl=function(){var r=o.getSelectedCompanyId();r&&t.search().cid!==r&&!e.transition&&(n.cid=r,e.params.cid=r,t.search("cid",r))},this.updateSelectedCompanyFromUrl=function(){var r=t.search().cid;if(r&&o.getUserCompanyId()&&r!==o.getSelectedCompanyId())o.switchCompany(r);else if(!r&&o.getSelectedCompanyId()){var i=t.absUrl();n.cid=o.getSelectedCompanyId(),e.params.cid=o.getSelectedCompanyId(),t.search("cid",o.getSelectedCompanyId()),i===t.destUrl&&t.replace()}},this.locationChangeSuccess=function(e,n){t.destUrl=n}}])}(angular),function(e){"use strict";var n=function(e){return"/"===e[0]&&(e=e.slice(1)),e},t=function(e){var n={};return e.split("&").forEach(function(e){var t=e.split("=");n[t[0]]=t[1]}),n};e.module("risevision.common.components.userstate").value("DEFAULT_PROFILE_PICTURE","http://api.randomuser.me/portraits/med/men/33.jpg").value("OAUTH2_SCOPES","https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile").value("GOOGLE_OAUTH2_URL","https://accounts.google.com/o/oauth2/auth").run(["$location","$window","userState","$log",function(e,o,r,i){var a=e.path(),s=t(n(a));if(i.debug("URL params",s),r._restoreState(),s.access_token&&r._setUserToken(s),s.state){var c=JSON.parse(decodeURIComponent(s.state));c.p||c.s?(r._persistState(),o.location.replace(c.p+c.s+c.u)):e.$$html5?e.path(""):o.location.hash=c.u}}]).factory("userState",["$q","$log","$location","CLIENT_ID","gapiLoader","OAUTH2_SCOPES","userInfoCache","getOAuthUserInfo","getUserProfile","companyState","objectHelper","$rootScope","$interval","$loading","$window","GOOGLE_OAUTH2_URL","localStorageService","$document","uiFlowManager","getBaseDomain","rvTokenStore","externalLogging",function(n,t,o,r,i,a,s,c,u,l,m,p,d,f,g,y,v,C,h,S,b,U){var _,E,R={profile:{},user:{},roleMap:{},userToken:b.read(),inRVAFrame:e.isDefined(o.search().inRVA)},w=null,I=!0,k=function(e){if(I){I=!1;try{var n=(new Date).getTime()-g.performance.timing.navigationStart;U.logEvent("page load time",e,n,X.getUsername(),X.getSelectedCompanyId())}catch(o){t.debug("Error logging load time")}}},T=function(){var e=b.read();e!==R.userToken?g.location.reload():R.userToken&&H(!0).finally(function(){R.userToken||(t.debug("Authentication failed. Reloading..."),g.location.reload())})},O=function(){var e,n,o=C[0];"undefined"!=typeof o.hidden?(n="visibilitychange",e="visibilityState"):"undefined"!=typeof o.mozHidden?(n="mozvisibilitychange",e="mozVisibilityState"):"undefined"!=typeof o.msHidden?(n="msvisibilitychange",e="msVisibilityState"):"undefined"!=typeof o.webkitHidden&&(n="webkitvisibilitychange",e="webkitVisibilityState"),o.addEventListener(n,function(){t.debug("visibility: "+o[e]),"visible"===o[e]&&T()})};O();var A=function(){R.userToken=X.getUsername(),b.write(R.userToken)},$=function(){t.debug("Clearing user token..."),j(),R.userToken=null,b.clear()},L=function(){d.cancel(w),w=d(function(){d.cancel(w),H(!0)},33e5)},j=function(){d.cancel(w),w=null},D=function(){E=null,m.clearObj(R.user),m.clearObj(R.profile),R.roleMap={},l.resetCompanyState(),t.debug("User state has been reset.")},N=function(){var e=n.defer();return u(R.user.username,!0).then(function(e){return X.updateUserProfile(e),l.init()}).then(function(){e.resolve()},e.reject),e.promise},G=function(e){var s=n.defer(),c={client_id:r,scope:a,cookie_policy:o.protocol()+"://"+S()};return"dummy"!==R.userToken&&(c.authuser=R.userToken),e?c.immediate=!0:c.prompt="select_account",i().then(function(e){e.auth.setToken(R.params),e.auth.authorize(c,function(e){t.debug("authResult",e),e&&!e.error?(R.params&&delete R.params,L(),s.resolve(e)):($(),s.reject(e.error||"failed to authorize user"))})}).then(null,s.reject),s.promise},H=function(e){if(_)return _.promise;_=n.defer();var t;return G(e).then(function(e){return t=e,c()}).then(function(n){R.user.username&&R.profile.username&&R.user.username===n.email?(_.resolve(t),_=void 0):(m.clearAndCopy({userId:n.id,username:n.email,picture:n.picture},R.user),A(),N().finally(function(){_.resolve(t),p.$broadcast("risevision.user.authorized"),e||p.$broadcast("risevision.user.userSignedIn"),_=void 0}))}).then(null,function(e){m.clearObj(R.user),_.reject(e),_=void 0}),_.promise},F=function(e){if(e){var t,o,i,s;p.redirectToRoot===!1?t=g.location.href.substr(0,g.location.href.indexOf("#"))||g.location.href:(t=g.location.origin+"/",o=g.location.pathname?g.location.pathname.substring(1):"",i=g.location.search),s=encodeURIComponent(encodeURIComponent(JSON.stringify({p:o,u:g.location.hash,s:i}))),v.set("risevision.common.userState",R),h.persist(),g.location.href=y+"?response_type=token&scope="+encodeURIComponent(a)+"&client_id="+r+"&redirect_uri="+encodeURIComponent(t)+"&prompt=select_account&state="+s;var c=n.defer();return c.promise}return x(e)},x=function(o){var r;if(o&&(D(),s.removeAll()),E)return E.promise;E=n.defer(),r=E,t.debug("authentication called");var a=function(){var n=e.isDefined(R.userToken)&&null!==R.userToken;if(t.debug("userAuthed",n),o||n===!0)H(!o).then(function(e){e&&!e.error?r.resolve():($(),t.debug("Authentication Error: "+e.error),r.reject("Authentication Error: "+e.error))}).then(null,function(e){$(),r.reject(e)}).finally(function(){f.stopGlobal("risevision.user.authenticate"),k("authenticated user")});else{var i="user is not authenticated";t.debug(i),r.reject(i),m.clearObj(R.user),f.stopGlobal("risevision.user.authenticate"),k("unauthenticated user")}};return i().finally(a),o&&f.startGlobal("risevision.user.authenticate"),r.promise},B=function(e){var o=n.defer();return s.removeAll(),i().then(function(n){e&&(g.logoutFrame.location="https://accounts.google.com/Logout"),n.auth.signOut(),$(),D(),m.clearObj(R.user),p.$broadcast("risevision.user.signedOut"),t.debug("User is signed out."),o.resolve()},function(){o.reject()}),o.promise},P=function(){return R.user.username?!0:!1},V=function(){return null!==R.profile.username&&void 0!==R.profile.username},z=function(n){return e.isDefined(R.roleMap[n])},M=function(){return g.gapi?g.gapi.auth.getToken():null},q=function(){var n=v.get("risevision.common.userState");n&&(e.extend(R,n),v.remove("risevision.common.userState"),t.debug("userState restored with",n))},X={getUsername:function(){return R.user&&R.user.username||null},getUserEmail:function(){return R.profile.email},getCopyOfProfile:function(n){return n?e.extend({},R.profile):m.follow(R.profile)},getUserPicture:function(){return R.user.picture},hasRole:z,inRVAFrame:function(){return R.inRVAFrame},isRiseAdmin:function(){return z("sa")&&l.isRootCompany()},isRiseStoreAdmin:function(){return z("ba")&&l.isRootCompany()},isUserAdmin:function(){return z("ua")},isPurchaser:function(){return z("pu")},isSeller:l.isSeller,isRiseVisionUser:V,isLoggedIn:P,getAccessToken:M,checkUsername:function(e){return!(!e||!X.getUsername()||e.toUpperCase()!==X.getUsername().toUpperCase())},updateUserProfile:function(n){X.checkUsername(n.username)&&(m.clearAndCopy(e.extend({username:R.user.username},n),R.profile),R.roleMap={},R.profile.roles&&R.profile.roles.forEach(function(e){R.roleMap[e]=!0}),p.$broadcast("risevision.user.updated"))},authenticate:R.inRVAFrame?x:F,authenticatePopup:function(){return x(!0)},signOut:B,refreshProfile:N,getUserCompanyId:l.getUserCompanyId,getUserCompanyName:l.getUserCompanyName,getSelectedCompanyId:l.getSelectedCompanyId,getSelectedCompanyName:l.getSelectedCompanyName,getSelectedCompanyCountry:l.getSelectedCompanyCountry,getCopyOfUserCompany:l.getCopyOfUserCompany,getCopyOfSelectedCompany:l.getCopyOfSelectedCompany,isSubcompanySelected:l.isSubcompanySelected,isTestCompanySelected:l.isTestCompanySelected,isRootCompany:l.isRootCompany,updateCompanySettings:l.updateCompanySettings,updateUserCompanySettings:l.updateUserCompanySettings,resetCompany:l.resetCompany,switchCompany:l.switchCompany,_restoreState:q,_setUserToken:function(e){R.params=e,R.userToken="dummy"},_persistState:function(){v.set("risevision.common.userState",R)}};return X}])}(angular),function(e){"use strict";e.module("risevision.common.components.util").value("humanReadableError",function(e){var n;return n=e.message?e.message:e.error?e.error.message?e.error.message:e.error:e,JSON.stringify(n)}).factory("dateIsInRange",[function(){return function(e,n,t){var o,r,i=!0;try{n&&(o=n.match(/(\d{4})\-(\d{2})\-(\d{2})/),r=new Date(o[1],parseInt(o[2])-1,o[3],0,0,0,0),i=e>=r),i&&t&&(o=t.match(/(\d{4})\-(\d{2})\-(\d{2})/),r=new Date(o[1],parseInt(o[2])-1,o[3],0,0,0,0),i=r>=e)}catch(a){i=!1}return i}}]).factory("objectHelper",[function(){var n={};return n.follow=function(e){var n=function(){};return n.prototype=e,new n},n.clearObj=function(e){for(var n in e)delete e[n]},n.clearAndCopy=function(t,o){n.clearObj(o),e.extend(o,t)},n}]).factory("getBaseDomain",["$log","$location",function(e,n){var t=function(e){return/^([0-9])+\.([0-9])+\.([0-9])+\.([0-9])+$/.test(e)?!0:!1};return function(){var o;if(!o){var r=n.host();if(t(r))o=r;else{var i=r.split(".");o=i.length>1?"appspot"===i[i.length-2]?i.slice(i.length-3).join("."):i.slice(i.length-2).join("."):r}e.debug("baseDomain",o)}return o}}])}(angular);