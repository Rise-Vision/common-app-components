!function(e){"use strict";try{e.module("risevision.common.config")}catch(n){e.module("risevision.common.config",[])}e.module("risevision.common.config").value("ENABLE_EXTERNAL_LOGGING",!0).value("CORE_URL","https://rvaserver2.appspot.com/_ah/api"),e.module("risevision.common.components.util",[]),e.module("risevision.common.components.logging",[]),e.module("risevision.common.components.rvtokenstore",["risevision.common.components.util","LocalStorageModule","ngBiscuit"]),e.module("risevision.common.components.userstate",["ui.router","risevision.common.components.util","risevision.common.components.rvtokenstore","risevision.common.components.logging","risevision.common.config","risevision.common.gapi","LocalStorageModule","risevision.core.cache","risevision.core.oauth2","risevision.core.company","risevision.core.util","risevision.core.userprofile","risevision.common.loading","risevision.ui-flow"]).value("CLIENT_ID","614513768474.apps.googleusercontent.com")}(angular),angular.module("risevision.common.components.logging").factory("bigQueryLogging",["externalLogging","userState",function(e,n){var t={};return t.logEvent=function(t,o,r,i,a){return e.logEvent(t,o,r,i||n.getUsername(),a||n.getSelectedCompanyId())},t}]),function(e){"use strict";e.module("risevision.common.components.userstate").factory("companyState",["$location","getCompany","objectHelper","$rootScope","$log","$q",function(n,t,o,r,i,a){var s,u={userCompany:{},selectedCompany:{}},c=function(){o.clearObj(u.selectedCompany),o.clearObj(u.userCompany),i.debug("Company state has been reset.")};n.search().cid&&(i.debug("cid",n.search().cid,"saved for later processing."),s=n.search().cid);var l=function(){var e=a.defer();return t().then(function(e){var n=p.getSelectedCompanyId()?p.getSelectedCompanyId():s;return o.clearAndCopy(e,u.userCompany),m(n)}).then(null,function(){p.resetCompany()}).finally(function(){s=null,e.resolve(null)}),e.promise},m=function(e){var n=a.defer();return e&&e!==u.userCompany.id?t(e).then(function(e){o.clearAndCopy(e,u.selectedCompany),n.resolve(),r.$broadcast("risevision.company.selectedCompanyChanged")}).then(null,function(e){console.error("Failed to load selected company.",e),n.reject(e)}):(p.resetCompany(),n.resolve()),n.promise},p={init:l,switchCompany:m,updateCompanySettings:function(e){e&&e.id===p.getSelectedCompanyId()&&o.clearAndCopy(e,u.selectedCompany),e&&e.id===p.getUserCompanyId()&&o.clearAndCopy(e,u.userCompany),r.$broadcast("risevision.company.updated",{companyId:e.id})},resetCompany:function(){o.clearAndCopy(u.userCompany,u.selectedCompany),r.$broadcast("risevision.company.selectedCompanyChanged")},resetCompanyState:c,getUserCompanyId:function(){return u.userCompany&&u.userCompany.id||null},getUserCompanyName:function(){return u.userCompany&&u.userCompany.name||null},getSelectedCompanyId:function(){return u.selectedCompany&&u.selectedCompany.id||null},getSelectedCompanyName:function(){return u.selectedCompany&&u.selectedCompany.name||null},getSelectedCompanyCountry:function(){return u.selectedCompany&&u.selectedCompany.country||null},getCopyOfUserCompany:function(n){return n?e.extend({},u.userCompany):o.follow(u.userCompany)},getCopyOfSelectedCompany:function(n){return n?e.extend({},u.selectedCompany):o.follow(u.selectedCompany)},isSubcompanySelected:function(){return u.selectedCompany&&u.selectedCompany.id!==(u.userCompany&&u.userCompany.id)},isTestCompanySelected:function(){return u.selectedCompany&&u.selectedCompany.isTest===!0},isSeller:function(){return u.selectedCompany&&u.selectedCompany.sellerId?!0:!1},isRootCompany:function(){return u.userCompany&&!u.userCompany.parentId}};return p}])}(angular),angular.module("risevision.common.components.logging").constant("EXTERNAL_LOGGER_SERVICE_URL","https://www.googleapis.com/bigquery/v2/projects/client-side-events/datasets/Apps_Events/tables/TABLE_ID/insertAll").constant("EXTERNAL_LOGGER_REFRESH_URL","https://www.googleapis.com/oauth2/v3/token?client_id=1088527147109-6q1o2vtihn34292pjt4ckhmhck0rk0o7.apps.googleusercontent.com&client_secret=nlZyrcPLg6oEwO9f9Wfn29Wh&refresh_token=1/xzt4kwzE1H7W9VnKB8cAaCx6zb4Es4nKEoqaYHdTD15IgOrJDtdun6zK6XiATCKT&grant_type=refresh_token").factory("externalLogging",["$http","$window","$q","$log","EXTERNAL_LOGGER_REFRESH_URL","EXTERNAL_LOGGER_SERVICE_URL","ENABLE_EXTERNAL_LOGGING",function(e,n,t,o,r,i,a){var s,u,c={},l=function(){var e=new Date,n=e.getUTCFullYear(),t=e.getUTCMonth()+1,o=e.getUTCDate();return 10>t&&(t="0"+t),10>o&&(o="0"+o),n.toString()+t.toString()+o.toString()},m={kind:"bigquery#tableDataInsertAllRequest",skipInvalidRows:!1,ignoreUnknownValues:!1,templateSuffix:l(),rows:[{insertId:"",json:{event:"",event_details:"",event_value:0,host:"",ts:0,user_id:"",company_id:""}}]};return c.logEvent=function(r,s,u,l,p){if(o.debug("BQ log",r,s,u,l,p),a===!1)return o.debug("External Logging DISABLED"),void 0;var d=t.defer();return c.getToken().then(function(t){var a=JSON.parse(JSON.stringify(m)),c=i.replace("TABLE_ID","apps_events");a.rows[0].insertId=Math.random().toString(36).substr(2).toUpperCase(),a.rows[0].json.event=r,s&&(a.rows[0].json.event_details=s),u&&(a.rows[0].json.event_value=u),a.rows[0].json.user_id=l||"",a.rows[0].json.company_id=p||"",a.rows[0].json.host=n.location.hostname,a.rows[0].json.ts=(new Date).toISOString(),e.post(c,a,{headers:{"Content-Type":"application/json",Authorization:"Bearer "+t}}).then(function(e){d.resolve(e)},function(e){o.debug("error posting to BQ",e),d.reject(e)})},function(e){o.debug("BQ token ERROR",e),d.reject(e)}),d.promise},c.getToken=function(){var n=t.defer();return s&&(new Date).getTime()-u<358e4?n.resolve(s):e.post(r).then(function(e){s=e.data.access_token,u=(new Date).getTime(),n.resolve(e.data.access_token)},function(){n.reject()}),n.promise},c}]),function(e){"use strict";e.module("risevision.common.components.rvtokenstore").service("rvTokenStore",["$log","$location","cookieStore","getBaseDomain",function(e,n,t,o){var r=function(){return t.get("rv-token")},i=function(e){var n=o();"localhost"===n?t.put("rv-token",e,{path:"/"}):t.put("rv-token",e,{domain:n,path:"/"})},a=function(){var e=o();"localhost"===e?t.remove("rv-token",{path:"/"}):t.remove("rv-token",{domain:e,path:"/"})},s={read:r,write:i,clear:a};return s}])}(angular),function(e){"use strict";e.module("risevision.common.components.userstate").run(["$rootScope","userState","selectedCompanyUrlHandler",function(e,n,t){e.$on("risevision.company.selectedCompanyChanged",function(e){e&&t.updateUrl()}),e.$on("$stateChangeSuccess",t.updateSelectedCompanyFromUrl),e.$on("$routeChangeSuccess",t.updateSelectedCompanyFromUrl),e.$on("$locationChangeSuccess",t.locationChangeSuccess)}]).service("selectedCompanyUrlHandler",["$state","$stateParams","$location","userState",function(e,n,t,o){this.updateUrl=function(){var r=o.getSelectedCompanyId();r&&t.search().cid!==r&&!e.transition&&(n.cid=r,e.params.cid=r,t.search("cid",r))},this.updateSelectedCompanyFromUrl=function(){var r=t.search().cid;if(r&&o.getUserCompanyId()&&r!==o.getSelectedCompanyId())o.switchCompany(r);else if(!r&&o.getSelectedCompanyId()){var i=t.absUrl();n.cid=o.getSelectedCompanyId(),e.params.cid=o.getSelectedCompanyId(),t.search("cid",o.getSelectedCompanyId()),i===t.destUrl&&t.replace()}},this.locationChangeSuccess=function(e,n){t.destUrl=n}}])}(angular),function(e){"use strict";var n=function(e){return"/"===e[0]&&(e=e.slice(1)),e},t=function(e){var n={};return e.split("&").forEach(function(e){var t=e.split("=");n[t[0]]=t[1]}),n};e.module("risevision.common.components.userstate").value("DEFAULT_PROFILE_PICTURE","http://api.randomuser.me/portraits/med/men/33.jpg").value("OAUTH2_SCOPES","https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile").value("GOOGLE_OAUTH2_URL","https://accounts.google.com/o/oauth2/auth").run(["$location","$window","userState","$log",function(e,o,r,i){var a=e.path(),s=t(n(a));if(i.debug("URL params",s),r._restoreState(),s.access_token&&r._setUserToken(s),s.state){var u=JSON.parse(decodeURIComponent(s.state));u.p||u.s?(r._persistState(),o.location.replace(u.p+u.s+u.u)):e.$$html5?e.path(""):o.location.hash=u.u}}]).factory("userState",["$q","$log","$location","CLIENT_ID","gapiLoader","OAUTH2_SCOPES","userInfoCache","getOAuthUserInfo","getUserProfile","companyState","objectHelper","$rootScope","$interval","$loading","$window","GOOGLE_OAUTH2_URL","localStorageService","$document","uiFlowManager","getBaseDomain","rvTokenStore","externalLogging","$http",function(n,t,o,r,i,a,s,u,c,l,m,p,d,f,g,y,v,C,h,S,b,U,E){var _,w,I={profile:{},user:{},roleMap:{},userToken:b.read(),inRVAFrame:e.isDefined(o.search().inRVA)},R=null,k=!0,T=function(e){if(k){k=!1;try{var n=(new Date).getTime()-g.performance.timing.navigationStart;U.logEvent("page load time",e,n,W.getUsername(),W.getSelectedCompanyId())}catch(o){t.debug("Error logging load time")}}},A=function(){var e=b.read();e!==I.userToken?g.location.reload():I.userToken&&x(!0).finally(function(){I.userToken||(t.debug("Authentication failed. Reloading..."),g.location.reload())})},O=function(){var e,n=C[0];"undefined"!=typeof n.hidden?e="visibilityState":"undefined"!=typeof n.mozHidden?e="mozVisibilityState":"undefined"!=typeof n.msHidden?e="msVisibilityState":"undefined"!=typeof n.webkitHidden&&(e="webkitVisibilityState"),t.debug("visibility: "+n[e]),"visible"===n[e]&&A()},L=function(){var e,n=C[0];return"undefined"!=typeof n.hidden?e="visibilitychange":"undefined"!=typeof n.mozHidden?e="mozvisibilitychange":"undefined"!=typeof n.msHidden?e="msvisibilitychange":"undefined"!=typeof n.webkitHidden&&(e="webkitvisibilitychange"),e},$=function(){document.addEventListener(L(),O)},j=function(){document.removeEventListener(L(),O)};$();var D=function(){I.userToken=W.getUsername(),b.write(I.userToken)},N=function(){t.debug("Clearing user token..."),H(),I.userToken=null,b.clear()},G=function(){d.cancel(R),R=d(function(){d.cancel(R),x(!0)},33e5)},H=function(){d.cancel(R),R=null},P=function(){w=null,m.clearObj(I.user),m.clearObj(I.profile),I.roleMap={},l.resetCompanyState(),t.debug("User state has been reset.")},F=function(){var e=n.defer();return c(I.user.username,!0).then(function(e){return W.updateUserProfile(e),l.init()}).then(function(){e.resolve()},e.reject),e.promise},V=function(e){var s=n.defer(),u={client_id:r,scope:a,cookie_policy:o.protocol()+"://"+S()};return u.authuser="dummy"!==I.userToken?I.userToken:E.get("https://www.googleapis.com/oauth2/v1/userinfo?access_token="+I.params.access_token).then(function(e){return e.data.email},function(){return t.debug("Error retrieving userinfo"),u.authuser}),e?u.immediate=!0:u.prompt="select_account",n.all([i(),u.authuser]).then(function(e){var n=e[0];u.authuser=e[1],n.auth.setToken(I.params),n.auth.authorize(u,function(e){t.debug("authResult"),e&&!e.error?(I.params&&delete I.params,G(),s.resolve(e)):(N(),s.reject(e.error||"failed to authorize user"))})}).then(null,s.reject),s.promise},x=function(e){if(_)return _.promise;_=n.defer();var t;return V(e).then(function(e){return t=e,u()}).then(function(n){I.user.username&&I.profile.username&&I.user.username===n.email?(_.resolve(t),_=void 0):(m.clearAndCopy({userId:n.id,username:n.email,picture:n.picture},I.user),D(),F().finally(function(){_.resolve(t),p.$broadcast("risevision.user.authorized"),e||p.$broadcast("risevision.user.userSignedIn"),_=void 0}))}).then(null,function(e){m.clearObj(I.user),_.reject(e),_=void 0}),_.promise},B=function(e){if(e){var t,o,i,s;p.redirectToRoot===!1?t=g.location.href.substr(0,g.location.href.indexOf("#"))||g.location.href:(t=g.location.origin+"/",o=g.location.pathname?g.location.pathname.substring(1):"",i=g.location.search),s=encodeURIComponent(encodeURIComponent(JSON.stringify({p:o,u:g.location.hash,s:i}))),v.set("risevision.common.userState",I),h.persist(),g.location.href=y+"?response_type=token&scope="+encodeURIComponent(a)+"&client_id="+r+"&redirect_uri="+encodeURIComponent(t)+"&prompt=select_account&state="+s;var u=n.defer();return u.promise}return z(e)},z=function(o){var r;if(o&&(P(),s.removeAll()),w)return w.promise;w=n.defer(),r=w,t.debug("authentication called");var a=function(){var n=e.isDefined(I.userToken)&&null!==I.userToken;if(t.debug("userAuthed",n),o||n===!0)x(!o).then(function(e){e&&!e.error?r.resolve():(N(),t.debug("Authentication Error: "+e.error),r.reject("Authentication Error: "+e.error))}).then(null,function(e){N(),r.reject(e)}).finally(function(){f.stopGlobal("risevision.user.authenticate"),T("authenticated user")});else{var i="user is not authenticated";t.debug(i),r.reject(i),m.clearObj(I.user),f.stopGlobal("risevision.user.authenticate"),T("unauthenticated user")}};return i().finally(a),o&&f.startGlobal("risevision.user.authenticate"),r.promise},M=function(e){var o=n.defer();return s.removeAll(),i().then(function(n){e&&(g.logoutFrame.location="https://accounts.google.com/Logout"),n.auth.signOut(),N(),P(),m.clearObj(I.user),p.$broadcast("risevision.user.signedOut"),t.debug("User is signed out."),o.resolve()},function(){o.reject()}),o.promise},q=function(){return I.user.username?!0:!1},X=function(){return null!==I.profile.username&&void 0!==I.profile.username},J=function(n){return e.isDefined(I.roleMap[n])},K=function(){return g.gapi?g.gapi.auth.getToken():null},Q=function(){var n=v.get("risevision.common.userState");n&&(e.extend(I,n),v.remove("risevision.common.userState"),t.debug("userState restored with",n))},W={getUsername:function(){return I.user&&I.user.username||null},getUserEmail:function(){return I.profile.email},getCopyOfProfile:function(n){return n?e.extend({},I.profile):m.follow(I.profile)},getUserPicture:function(){return I.user.picture},hasRole:J,inRVAFrame:function(){return I.inRVAFrame},isRiseAdmin:function(){return J("sa")&&l.isRootCompany()},isRiseStoreAdmin:function(){return J("ba")&&l.isRootCompany()},isUserAdmin:function(){return J("ua")},isPurchaser:function(){return J("pu")},isSeller:l.isSeller,isRiseVisionUser:X,isLoggedIn:q,getAccessToken:K,checkUsername:function(e){return!(!e||!W.getUsername()||e.toUpperCase()!==W.getUsername().toUpperCase())},updateUserProfile:function(n){W.checkUsername(n.username)&&(m.clearAndCopy(e.extend({username:I.user.username},n),I.profile),I.roleMap={},I.profile.roles&&I.profile.roles.forEach(function(e){I.roleMap[e]=!0}),p.$broadcast("risevision.user.updated"))},authenticate:I.inRVAFrame?z:B,authenticatePopup:function(){return z(!0)},signOut:M,refreshProfile:F,addEventListenerVisibilityAPI:$,removeEventListenerVisibilityAPI:j,getUserCompanyId:l.getUserCompanyId,getUserCompanyName:l.getUserCompanyName,getSelectedCompanyId:l.getSelectedCompanyId,getSelectedCompanyName:l.getSelectedCompanyName,getSelectedCompanyCountry:l.getSelectedCompanyCountry,getCopyOfUserCompany:l.getCopyOfUserCompany,getCopyOfSelectedCompany:l.getCopyOfSelectedCompany,isSubcompanySelected:l.isSubcompanySelected,isTestCompanySelected:l.isTestCompanySelected,isRootCompany:l.isRootCompany,updateCompanySettings:l.updateCompanySettings,updateUserCompanySettings:l.updateUserCompanySettings,resetCompany:l.resetCompany,switchCompany:l.switchCompany,_restoreState:Q,_setUserToken:function(e){I.params=e,I.userToken="dummy"},_persistState:function(){v.set("risevision.common.userState",I)}};return W}])}(angular),function(e){"use strict";e.module("risevision.common.components.util").value("humanReadableError",function(e){var n;return n=e.message?e.message:e.error?e.error.message?e.error.message:e.error:e,JSON.stringify(n)}).factory("dateIsInRange",[function(){return function(e,n,t){var o,r,i=!0;try{n&&(o=n.match(/(\d{4})\-(\d{2})\-(\d{2})/),r=new Date(o[1],parseInt(o[2])-1,o[3],0,0,0,0),i=e>=r),i&&t&&(o=t.match(/(\d{4})\-(\d{2})\-(\d{2})/),r=new Date(o[1],parseInt(o[2])-1,o[3],0,0,0,0),i=r>=e)}catch(a){i=!1}return i}}]).factory("objectHelper",[function(){var n={};return n.follow=function(e){var n=function(){};return n.prototype=e,new n},n.clearObj=function(e){for(var n in e)delete e[n]},n.clearAndCopy=function(t,o){n.clearObj(o),e.extend(o,t)},n}]).factory("getBaseDomain",["$log","$location",function(e,n){var t=function(e){return/^([0-9])+\.([0-9])+\.([0-9])+\.([0-9])+$/.test(e)?!0:!1};return function(){var o;if(!o){var r=n.host();if(t(r))o=r;else{var i=r.split(".");o=i.length>1?"appspot"===i[i.length-2]?i.slice(i.length-3).join("."):i.slice(i.length-2).join("."):r}e.debug("baseDomain",o)}return o}}])}(angular);