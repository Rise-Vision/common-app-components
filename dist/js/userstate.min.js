!function(e){"use strict";try{e.module("risevision.common.config")}catch(n){e.module("risevision.common.config",[])}e.module("risevision.common.config").value("ENABLE_EXTERNAL_LOGGING",!0).value("CORE_URL","https://rvaserver2.appspot.com/_ah/api"),e.module("risevision.common.components.util",[]),e.module("risevision.common.components.logging",[]),e.module("risevision.common.components.rvtokenstore",["risevision.common.components.util","LocalStorageModule","ngBiscuit"]),e.module("risevision.common.components.userstate",["risevision.common.components.util","risevision.common.components.rvtokenstore","risevision.common.components.logging","risevision.common.config","risevision.common.gapi","LocalStorageModule","risevision.core.cache","risevision.core.oauth2","risevision.core.company","risevision.core.util","risevision.core.userprofile","risevision.common.loading","risevision.ui-flow"]).value("CLIENT_ID","614513768474.apps.googleusercontent.com")}(angular),angular.module("risevision.common.components.logging").factory("bigQueryLogging",["externalLogging","userState",function(e,n){var o={};return o.logEvent=function(o,t,r){return e.logEvent(o,t,r,n.getUsername(),n.getSelectedCompanyId())},o}]),function(e){"use strict";e.module("risevision.common.components.userstate").factory("companyState",["$location","getCompany","objectHelper","$rootScope","$log","$q",function(n,o,t,r,i,a){var s,u={userCompany:{},selectedCompany:{}},c=function(){t.clearObj(u.selectedCompany),t.clearObj(u.userCompany),i.debug("Company state has been reset.")};n.search().cid&&(i.debug("cid",n.search().cid,"saved for later processing."),s=n.search().cid);var l=function(){var e=a.defer();return o().then(function(e){var n=p.getSelectedCompanyId()?p.getSelectedCompanyId():s;return t.clearAndCopy(e,u.userCompany),m(n)}).then(null,function(){p.resetCompany()}).finally(function(){s=null,e.resolve(null)}),e.promise},m=function(e){var n=a.defer();return e&&e!==u.userCompany.id?o(e).then(function(e){t.clearAndCopy(e,u.selectedCompany),n.resolve(),r.$broadcast("risevision.company.selectedCompanyChanged")}).then(null,function(e){i.error("Failed to load selected company.",e),n.reject(e)}):(p.resetCompany(),n.resolve()),n.promise},p={init:l,switchCompany:m,updateCompanySettings:function(e){e&&e.id===p.getSelectedCompanyId()&&t.clearAndCopy(e,u.selectedCompany),e&&e.id===p.getUserCompanyId()&&t.clearAndCopy(e,u.userCompany),r.$broadcast("risevision.company.updated",{companyId:e.id})},resetCompany:function(){t.clearAndCopy(u.userCompany,u.selectedCompany),r.$broadcast("risevision.company.selectedCompanyChanged")},resetCompanyState:c,getUserCompanyId:function(){return u.userCompany&&u.userCompany.id||null},getUserCompanyName:function(){return u.userCompany&&u.userCompany.name||null},getSelectedCompanyId:function(){return u.selectedCompany&&u.selectedCompany.id||null},getSelectedCompanyName:function(){return u.selectedCompany&&u.selectedCompany.name||null},getSelectedCompanyCountry:function(){return u.selectedCompany&&u.selectedCompany.country||null},getCopyOfUserCompany:function(n){return n?e.extend({},u.userCompany):t.follow(u.userCompany)},getCopyOfSelectedCompany:function(n){return n?e.extend({},u.selectedCompany):t.follow(u.selectedCompany)},isSubcompanySelected:function(){return u.selectedCompany&&u.selectedCompany.id!==(u.userCompany&&u.userCompany.id)},isTestCompanySelected:function(){return u.selectedCompany&&u.selectedCompany.isTest===!0},isSeller:function(){return u.selectedCompany&&u.selectedCompany.sellerId?!0:!1},isRootCompany:function(){return u.userCompany&&!u.userCompany.parentId}};return p}])}(angular),angular.module("risevision.common.components.logging").constant("EXTERNAL_LOGGER_SERVICE_URL","https://www.googleapis.com/bigquery/v2/projects/client-side-events/datasets/Apps_Events/tables/TABLE_ID/insertAll").constant("EXTERNAL_LOGGER_REFRESH_URL","https://www.googleapis.com/oauth2/v3/token?client_id=1088527147109-6q1o2vtihn34292pjt4ckhmhck0rk0o7.apps.googleusercontent.com&client_secret=nlZyrcPLg6oEwO9f9Wfn29Wh&refresh_token=1/xzt4kwzE1H7W9VnKB8cAaCx6zb4Es4nKEoqaYHdTD15IgOrJDtdun6zK6XiATCKT&grant_type=refresh_token").factory("externalLogging",["$http","$window","$q","$log","EXTERNAL_LOGGER_REFRESH_URL","EXTERNAL_LOGGER_SERVICE_URL","ENABLE_EXTERNAL_LOGGING",function(e,n,o,t,r,i,a){var s,u,c={},l=function(){var e=new Date,n=e.getUTCFullYear(),o=e.getUTCMonth()+1,t=e.getUTCDate();return 10>o&&(o="0"+o),10>t&&(t="0"+t),n.toString()+o.toString()+t.toString()},m={kind:"bigquery#tableDataInsertAllRequest",skipInvalidRows:!1,ignoreUnknownValues:!1,templateSuffix:l(),rows:[{insertId:"",json:{event:"",event_details:"",event_value:0,host:"",ts:0,user_id:"",company_id:""}}]};return c.logEvent=function(r,s,u,l,p){if(t.debug("BQ log",r,s,u,l,p),a===!1)return t.debug("External Logging DISABLED"),void 0;var d=o.defer();return c.getToken().then(function(o){var a=JSON.parse(JSON.stringify(m)),c=i.replace("TABLE_ID","apps_events");a.rows[0].insertId=Math.random().toString(36).substr(2).toUpperCase(),a.rows[0].json.event=r,s&&(a.rows[0].json.event_details=s),u&&(a.rows[0].json.event_value=u),a.rows[0].json.user_id=l||"",a.rows[0].json.company_id=p||"",a.rows[0].json.host=n.location.hostname,a.rows[0].json.ts=(new Date).toISOString(),e.post(c,a,{headers:{"Content-Type":"application/json",Authorization:"Bearer "+o}}).then(function(e){d.resolve(e)},function(e){t.debug("error posting to BQ",e),d.reject(e)})},function(e){t.debug("BQ token ERROR",e),d.reject(e)}),d.promise},c.getToken=function(){var n=o.defer();return s&&(new Date).getTime()-u<358e4?n.resolve(s):e.post(r).then(function(e){s=e.data.access_token,u=(new Date).getTime(),n.resolve(e.data.access_token)},function(){n.reject()}),n.promise},c}]),function(e){"use strict";e.module("risevision.common.components.rvtokenstore").service("rvTokenStore",["$log","$location","cookieStore","getBaseDomain",function(e,n,o,t){var r=function(){return o.get("rv-token")},i=function(e){var n=t();"localhost"===n?o.put("rv-token",e,{path:"/"}):o.put("rv-token",e,{domain:n,path:"/"})},a=function(){var e=t();"localhost"===e?o.remove("rv-token",{path:"/"}):o.remove("rv-token",{domain:e,path:"/"})},s={read:r,write:i,clear:a};return s}])}(angular),function(e){"use strict";var n=function(e){return"/"===e[0]&&(e=e.slice(1)),e},o=function(e){var n={};return e.split("&").forEach(function(e){var o=e.split("=");n[o[0]]=o[1]}),n};e.module("risevision.common.components.userstate").value("DEFAULT_PROFILE_PICTURE","http://api.randomuser.me/portraits/med/men/33.jpg").value("OAUTH2_SCOPES","https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile").value("GOOGLE_OAUTH2_URL","https://accounts.google.com/o/oauth2/auth").run(["$location","$window","userState","$log",function(e,t,r,i){var a=e.path(),s=o(n(a));if(i.debug("URL params",s),r._restoreState(),s.access_token&&r._setUserToken(s),s.state){var u=JSON.parse(decodeURIComponent(s.state));u.p||u.s?(r._persistState(),t.location.replace(u.p+u.s+u.u)):e.$$html5?e.path(""):t.location.hash=u.u}}]).factory("userState",["$q","$log","$location","CLIENT_ID","gapiLoader","OAUTH2_SCOPES","userInfoCache","getOAuthUserInfo","getUserProfile","companyState","objectHelper","$rootScope","$interval","$loading","$window","GOOGLE_OAUTH2_URL","localStorageService","$document","uiFlowManager","getBaseDomain","rvTokenStore","externalLogging",function(n,o,t,r,i,a,s,u,c,l,m,p,d,f,g,y,v,C,h,S,b,_){var E,U,R={profile:{},user:{},roleMap:{},userToken:b.read(),inRVAFrame:e.isDefined(t.search().inRVA)},w=null,k=!0,T=function(e){if(k){k=!1;try{var n=(new Date).getTime()-g.performance.timing.navigationStart;_.logEvent("page load time",e,n,X.getUsername(),X.getSelectedCompanyId())}catch(t){o.debug("Error logging load time")}}},I=function(){var e=b.read();e!==R.userToken?g.location.reload():R.userToken&&x(!0).finally(function(){R.userToken||(o.debug("Authentication failed. Reloading..."),g.location.reload())})},O=function(){var e,n,t=C[0];"undefined"!=typeof t.hidden?(n="visibilitychange",e="visibilityState"):"undefined"!=typeof t.mozHidden?(n="mozvisibilitychange",e="mozVisibilityState"):"undefined"!=typeof t.msHidden?(n="msvisibilitychange",e="msVisibilityState"):"undefined"!=typeof t.webkitHidden&&(n="webkitvisibilitychange",e="webkitVisibilityState"),t.addEventListener(n,function(){o.debug("visibility: "+t[e]),"visible"===t[e]&&I()})};O();var A=function(){R.userToken=X.getUsername(),b.write(R.userToken)},L=function(){o.debug("Clearing user token..."),$(),R.userToken=null,b.clear()},j=function(){d.cancel(w),w=d(function(){d.cancel(w),x(!0)},33e5)},$=function(){d.cancel(w),w=null},D=function(){U=null,m.clearObj(R.user),m.clearObj(R.profile),R.roleMap={},l.resetCompanyState(),o.debug("User state has been reset.")},N=function(){var e=n.defer();return c(R.user.username,!0).then(function(e){return X.updateUserProfile(e),l.init()}).then(function(){e.resolve()},e.reject),e.promise},G=function(e){var s=n.defer(),u={client_id:r,scope:a,cookie_policy:t.protocol()+"://"+S()};return"dummy"!==R.userToken&&(u.authuser=R.userToken),e?u.immediate=!0:u.prompt="select_account",i().then(function(e){e.auth.setToken(R.params),e.auth.authorize(u,function(e){o.debug("authResult",e),e&&!e.error?(R.params&&delete R.params,j(),s.resolve(e)):(L(),s.reject(e.error||"failed to authorize user"))})}).then(null,s.reject),s.promise},x=function(e){if(E)return E.promise;E=n.defer();var o;return G(e).then(function(e){return o=e,u()}).then(function(n){R.user.username&&R.profile.username&&R.user.username===n.email?(E.resolve(o),E=void 0):(m.clearAndCopy({userId:n.id,username:n.email,picture:n.picture},R.user),A(),N().finally(function(){E.resolve(o),p.$broadcast("risevision.user.authorized"),e||p.$broadcast("risevision.user.userSignedIn"),E=void 0}))}).then(null,function(e){m.clearObj(R.user),E.reject(e),E=void 0}),E.promise},B=function(e){if(e){var o,t,i,s;p.redirectToRoot===!1?o=g.location.href.substr(0,g.location.href.indexOf("#"))||g.location.href:(o=g.location.origin+"/",t=g.location.pathname?g.location.pathname.substring(1):"",i=g.location.search),s=encodeURIComponent(encodeURIComponent(JSON.stringify({p:t,u:g.location.hash,s:i}))),v.set("risevision.common.userState",R),h.persist(),g.location.href=y+"?response_type=token&scope="+encodeURIComponent(a)+"&client_id="+r+"&redirect_uri="+encodeURIComponent(o)+"&prompt=select_account&state="+s;var u=n.defer();return u.promise}return H(e)},H=function(t){var r;if(t&&(D(),s.removeAll()),U)return U.promise;U=n.defer(),r=U,o.debug("authentication called");var i=function(){var n=e.isDefined(R.userToken)&&null!==R.userToken;if(o.debug("userAuthed",n),t||n===!0)x(!t).then(function(e){e&&!e.error?r.resolve():(L(),o.debug("Authentication Error: "+e.error),r.reject("Authentication Error: "+e.error))}).then(null,function(e){L(),r.reject(e)}).finally(function(){f.stopGlobal("risevision.user.authenticate"),T("authenticated user")});else{var i="user is not authenticated";o.debug(i),r.reject(i),m.clearObj(R.user),f.stopGlobal("risevision.user.authenticate"),T("unauthenticated user")}};return i(),t&&f.startGlobal("risevision.user.authenticate"),r.promise},V=function(e){var t=n.defer();return s.removeAll(),i().then(function(n){e&&(g.logoutFrame.location="https://accounts.google.com/Logout"),n.auth.signOut(),L(),D(),m.clearObj(R.user),p.$broadcast("risevision.user.signedOut"),o.debug("User is signed out."),t.resolve()},function(){t.reject()}),t.promise},F=function(){return R.user.username?!0:!1},P=function(){return null!==R.profile.username&&void 0!==R.profile.username},z=function(n){return e.isDefined(R.roleMap[n])},M=function(){return g.gapi?g.gapi.auth.getToken():null},q=function(){var n=v.get("risevision.common.userState");n&&(e.extend(R,n),v.remove("risevision.common.userState"),o.debug("userState restored with",n))},X={getUsername:function(){return R.user&&R.user.username||null},getUserEmail:function(){return R.profile.email},getCopyOfProfile:function(n){return n?e.extend({},R.profile):m.follow(R.profile)},getUserPicture:function(){return R.user.picture},hasRole:z,inRVAFrame:function(){return R.inRVAFrame},isRiseAdmin:function(){return z("sa")&&l.isRootCompany()},isRiseStoreAdmin:function(){return z("ba")&&l.isRootCompany()},isUserAdmin:function(){return z("ua")},isPurchaser:function(){return z("pu")},isSeller:l.isSeller,isRiseVisionUser:P,isLoggedIn:F,getAccessToken:M,checkUsername:function(e){return!(!e||!X.getUsername()||e.toUpperCase()!==X.getUsername().toUpperCase())},updateUserProfile:function(n){X.checkUsername(n.username)&&(m.clearAndCopy(e.extend({username:R.user.username},n),R.profile),R.roleMap={},R.profile.roles&&R.profile.roles.forEach(function(e){R.roleMap[e]=!0}),p.$broadcast("risevision.user.updated"))},authenticate:R.inRVAFrame?H:B,signOut:V,refreshProfile:N,getUserCompanyId:l.getUserCompanyId,getUserCompanyName:l.getUserCompanyName,getSelectedCompanyId:l.getSelectedCompanyId,getSelectedCompanyName:l.getSelectedCompanyName,getSelectedCompanyCountry:l.getSelectedCompanyCountry,getCopyOfUserCompany:l.getCopyOfUserCompany,getCopyOfSelectedCompany:l.getCopyOfSelectedCompany,isSubcompanySelected:l.isSubcompanySelected,isTestCompanySelected:l.isTestCompanySelected,isRootCompany:l.isRootCompany,updateCompanySettings:l.updateCompanySettings,updateUserCompanySettings:l.updateUserCompanySettings,resetCompany:l.resetCompany,switchCompany:l.switchCompany,_restoreState:q,_setUserToken:function(e){R.params=e,R.userToken="dummy"},_persistState:function(){v.set("risevision.common.userState",R)}};return X}])}(angular),function(e){"use strict";e.module("risevision.common.components.util").value("humanReadableError",function(e){var n;return n=e.message?e.message:e.error?e.error.message?e.error.message:e.error:e,JSON.stringify(n)}).factory("dateIsInRange",[function(){return function(e,n,o){var t,r,i=!0;try{n&&(t=n.match(/(\d{4})\-(\d{2})\-(\d{2})/),r=new Date(t[1],parseInt(t[2])-1,t[3],0,0,0,0),i=e>=r),i&&o&&(t=o.match(/(\d{4})\-(\d{2})\-(\d{2})/),r=new Date(t[1],parseInt(t[2])-1,t[3],0,0,0,0),i=r>=e)}catch(a){i=!1}return i}}]).factory("objectHelper",[function(){var n={};return n.follow=function(e){var n=function(){};return n.prototype=e,new n},n.clearObj=function(e){for(var n in e)delete e[n]},n.clearAndCopy=function(o,t){n.clearObj(t),e.extend(t,o)},n}]).factory("getBaseDomain",["$log","$location",function(e,n){var o=function(e){return/^([0-9])+\.([0-9])+\.([0-9])+\.([0-9])+$/.test(e)?!0:!1};return function(){var t;if(!t){var r=n.host();if(o(r))t=r;else{var i=r.split(".");t=i.length>1?"appspot"===i[i.length-2]?i.slice(i.length-3).join("."):i.slice(i.length-2).join("."):r}e.debug("baseDomain",t)}return t}}])}(angular);